# SOC211 - Utilman.exe Winlogon Exploit Attempt


## Executive Summary

On June 21, 2023, the Security Operations Center (SOC) received an alert for a `Utilman.exe` exploit attempt on the host **Henry** (172.16.17.149). The investigation confirmed a successful, multi-stage attack where an adversary, having already gained initial access, replaced the legitimate Utility Manager (`Utilman.exe`) with a copy of the Command Prompt (`cmd.exe`). The attacker then triggered this backdoor from the Windows logon screen to gain a command prompt running with **NT AUTHORITY\SYSTEM** privileges. From there, they created a new local user (`superman`) and added it to the local Administrators group, successfully creating a persistent, privileged backdoor account. This is a **True Positive** for a critical host compromise.

## Incident Details

The initial alert was triggered by the execution of a command from the `Winlogon.exe` process space, a hallmark of this attack:

<img width="1389" height="615" alt="image" src="https://github.com/user-attachments/assets/d7bf80bd-b242-4d8a-9df6-7bb3eb8affc8" />

| | |
| :--- | :--- |
| **Date of Incident**| June 21, 2023 |
| **Source Host**| Henry (172.16.17.149) |
| **Backdoor User Created**| `superman` |
| **Attack Type**| Privilege Escalation / Persistence via Accessibility Features (MITRE ATT&CK T1546.008) |
| **Case Link**| *([Case link](https://app.letsdefend.io/case-management/casedetail/sohankanna/161))* |

## Investigation and Analysis

### 1. Alert Context: The "Utilman.exe" Exploit

This attack is a well-known persistence and privilege escalation technique often referred to as a "Sticky Keys" attack, though in this case, it uses the Utility Manager (`Utilman.exe`).
*   **Legitimate Use:** `Utilman.exe` is the process that launches the Ease of Access menu on the Windows logon screen (e.g., for the On-Screen Keyboard, Narrator, etc.). It is launched by `Winlogon.exe` and runs with high privileges (`SYSTEM`) so it can interact with the secure desktop.
*   **The Exploit:** An attacker with initial administrative access to a machine can replace the `Utilman.exe` binary in `C:\Windows\System32` with a copy of `cmd.exe`. When a user (or the attacker) later clicks the "Ease of Access" button on the logon screen, instead of the normal menu, a Command Prompt window opens. Because it was launched by `Winlogon.exe`, this command prompt runs as **NT AUTHORITY\SYSTEM**. This provides the attacker with a persistent way to regain SYSTEM-level access to the machine, even without knowing any user passwords.

### 2. Deconstructing the Attack Chain via Endpoint Logs

The EDR's command-line history provides a perfect, step-by-step narrative of the attacker's actions.

**Stage 1: Setting up the Backdoor (Requires Prior Access)**
<img width="1349" height="534" alt="image" src="https://github.com/user-attachments/assets/6d2069c2-e305-445d-b13c-4b4b2bdc644c" />
1.  **`rename utilman.exe utilman.old`:** The attacker renames the original, legitimate Utility Manager to back it up.
2.  **`copy cmd.exe utilman.exe`:** The attacker replaces `Utilman.exe` with a copy of the Command Prompt. At this point, the backdoor is armed.
3.  **`shutdown /h /t 0`:** The attacker hibernates or shuts down the machine to wait for the next logon event to trigger their backdoor.

**Stage 2: Executing the Backdoor and Escalating Privileges**
After the machine is powered back on and is at the logon screen, the attacker triggers the backdoor.
1.  **`net user superman onepunch123 /add`:** This is the command that triggered the alert. It was executed from the `Utilman.exe` (which is now `cmd.exe`) process, running as SYSTEM. The attacker creates a new local user named `superman`.
2.  **`net localgroup administrators superman /add`:** This is the privilege escalation step. The attacker adds their newly created `superman` account to the local Administrators group, giving it full administrative rights over the machine.
3.  **Reconnaissance:** The attacker also ran commands like `net user` and `whoami` to verify their actions and current privilege level.

### 3. Confirmation of Success

The compromise is confirmed by multiple pieces of evidence.
*   **Process Analysis:** EDR logs show `Utilman.exe` (which is actually `cmd.exe`) executing the `net user` command with `SYSTEM` privileges, with `Winlogon.exe` as its parent.
*   **User Creation:** The final "smoking gun" is the EDR log showing the `userinit.exe` process running under the context of the newly created `superman` user. This confirms the account was successfully created and used to log in.
    <img width="1189" height="423" alt="image" src="https://github.com/user-attachments/assets/9a051129-25aa-46d6-8e2a-e01d013f605e" />

## Skills and Tools Utilized

*   **Tools Used:** SIEM, EDR
*   **Skills Demonstrated:** TTP Recognition (Accessibility Features Exploit), Privilege Escalation Analysis, Windows Command Line Analysis, Attack Chain Reconstruction, Log Correlation.

## Playbook Solution: Incident Classification

*   **Is Traffic Malicious?** **Yes.** It is a classic privilege escalation and persistence technique.
*   **What Is The Attack Type?** **Privilege Escalation / Persistence.**
*   **Was the Attack Successful?** **Yes.** A new administrative account was successfully created.
*   **Do You Need Tier 2 Escalation?** **Yes.** A full system compromise with a new admin account requires immediate escalation.
*   **Incident Classification:** **True Positive.**

## Conclusion and Recommendations

The alert for SOC211 was a **true positive** for a successful privilege escalation and persistence attack. An attacker with prior access to the host **Henry** replaced the Utility Manager with a command prompt to create a persistent backdoor. They then used this backdoor to create a new local administrator account named `superman`, giving them complete and persistent control over the system.

**Recommendations:**

1.  **CONTAINMENT - Isolate Host Immediately:** Disconnect the host **Henry** (172.16.17.149) from the network to evict the attacker and prevent lateral movement.
2.  **ERADICATION:**
    *   Delete the malicious `superman` user account.
    *   Restore the original `Utilman.exe` from `utilman.old` (or from a known-good source) and delete the malicious copy.
3.  **ESCALATE:** Immediately escalate this incident to the Tier 2/Incident Response (IR) team for a full forensic investigation.
4.  **INVESTIGATION:** The primary goal for the IR team is to determine the initial access vector. *How* did the attacker gain the initial administrative access required to modify the System32 directory? The investigation must look for prior RDP brute-forces, malware infections, or other exploits.
5.  **RECOVERY:** The compromised host must be wiped and re-imaged from a known-good source. Simply removing the user and restoring the file is not sufficient, as the attacker had SYSTEM access and could have installed other backdoors.











