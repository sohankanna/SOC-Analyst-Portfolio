# SOC134 - Suspicious WMI Activity (Event ID:71)

## Executive Summary

On March 7, 2021, the Security Operations Center (SOC) received an alert for suspicious WMI activity on the host **Desktop-Anderson** (172.16.17.54). The investigation confirmed that a batch file, `exec.bat`, was executed. The script's sole purpose was to run **`wmiexec.py`**, a well-known hacking and penetration testing tool from the **Impacket** framework. The command attempted to use WMI to gain an administrative shell on the local machine (`127.0.0.1`). The `Device Action: Allowed` confirms the script was successfully executed. The use of such a tool is a high-confidence indicator of compromise, suggesting an attacker is attempting to escalate privileges or test their lateral movement capabilities. This is a **True Positive** critical incident.

## Incident Details

The initial alert was triggered by the malware's use of WMI for command and control:

<img width="1444" height="493" alt="image" src="https://github.com/user-attachments/assets/7d87f896-eabd-4243-a3c3-773db1a13210" />

| | |
| :--- | :--- |
| **Date of Incident**| March 7, 2021 |
| **Source Host**| Desktop-Anderson (172.16.17.54) |
| **Malware File**| exec.bat |
| **File Hash (MD5)**| 50459310eded4c520ab5c9e3626a9300 |
| **Tool Executed**| wmiexec.py (from the Impacket Framework) |
| **Attack Type**| Privilege Escalation / Lateral Movement Tool |
| **Case Link**| *([Case link)](https://app.letsdefend.io/case-management/casedetail/sohankanna/71)* |

## Investigation and Analysis

### 1. Alert Context: Suspicious WMI Activity

The rule `SOC134 - Suspicious WMI Activity` is designed to detect the malicious use of Windows Management Instrumentation. WMI is a legitimate administrative interface, but it is frequently abused by attackers as a "living-off-the-land" technique for stealthy command execution, lateral movement, and reconnaissance. An alert for WMI activity originating from a non-standard tool is a significant red flag.

### 2. Malware Analysis

The investigation focused on the `exec.bat` file and the command it was attempting to run.
*   **Threat Intelligence:** Initial automated scans on VirusTotal and Hybrid Analysis were inconclusive, with very few detections. This is expected for a simple batch file that just calls another script.
    <img width="1645" height="772" alt="image" src="https://github.com/user-attachments/assets/deac4ab0-34c4-4615-a7de-14f9b4175f72" />
    <img width="1597" height="733" alt="image" src="https://github.com/user-attachments/assets/70611ffa-793a-4600-9f75-901ff720b94d" />
*   **Static Code Analysis (The "Smoking Gun"):** Analysis of the batch file revealed a single, highly significant command:
    <img width="1232" height="575" alt="image" src="https://github.com/user-attachments/assets/d68e33be-ea26-4d9d-8f7b-6a1f937b9cdb" />

    `python wmiexec.py LetsDefend/Administrator@127.0.0.1`

    **Deconstructing this command reveals its malicious intent:**
    *   **`python wmiexec.py`:** This executes `wmiexec.py`, a script from the **Impacket** framework. Impacket is a powerful toolkit used by both red teams and threat actors to interact with Windows network protocols. `wmiexec.py` specifically provides a semi-interactive shell on a remote Windows host by executing commands via WMI.
    *   **`LetsDefend/Administrator`:** These are the credentials the attacker is using. They are attempting to authenticate as the `Administrator` user in the `LetsDefend` domain or workgroup.
    *   **`@127.0.0.1`:** This is the target. The IP `127.0.0.1` is the "localhost" address, meaning the attacker is targeting the very same machine the script is running on. While `wmiexec.py` is typically used for lateral movement to *other* machines, using it against localhost is a common technique for **privilege escalation** or to test if the tool and credentials work before attempting to move across the network.

### 3. Confirmation of Success

The SIEM alert itself provides the proof of successful execution. The **`Device Action: Allowed`** status means that the endpoint security controls did not stop the `exec.bat` script from running. Because the script ran, the `wmiexec.py` command was executed.

## Skills and Tools Utilized

*   **Tools Used:** SIEM, EDR, VirusTotal, Hybrid Analysis, Static Analysis
*   **Skills Demonstrated:** Triage, TTP Recognition (WMI Abuse, Impacket), Lateral Movement/Privilege Escalation Analysis, Static Code Analysis.

## Playbook Solution: Incident Classification

*   **Is Traffic Malicious?** **Yes.** The execution of a known hacking tool for command execution is malicious.
*   **What Is The Attack Type?** **Privilege Escalation / Lateral Movement.**
*   **Was the Attack Successful?** **Yes.** The script was allowed to run on the endpoint.
*   **Do You Need Tier 2 Escalation?** **Yes.** The presence and successful execution of a tool like Impacket on an endpoint is a critical incident.
*   **Incident Classification:** **True Positive.**

## Conclusion and Recommendations

The alert for SOC134 was a **true positive**. An attacker, having already gained initial access to the host **Desktop-Anderson**, executed a batch script to run the `wmiexec.py` hacking tool. This indicates the attacker is attempting to escalate their privileges or validate credentials for lateral movement. The host is compromised and is being used as a staging ground for a deeper attack.

**Recommendations:**

1.  **CONTAINMENT - Isolate Host Immediately:** Disconnect the host **Desktop-Anderson** (172.16.17.54) from the network to prevent the attacker from successfully moving laterally to other systems.
2.  **ESCALATE:** Immediately escalate this incident to the Tier 2/Incident Response (IR) team.
3.  **INVESTIGATION:** The primary goals for the IR team are:
    *   To determine the initial access vector. *How* did `exec.bat` and `wmiexec.py` get on the machine?
    *   To determine if the `Administrator` password is known to the attacker. The fact that they are using it suggests it may have been compromised. All administrator and privileged account passwords should be reset.
    *   To hunt for any signs of actual lateral movement originating from this host since the time of the alert.
4.  **RECOVERY:** The compromised host must be wiped and re-imaged from a known-good source.
5.  **BLOCK INDICATORS:** Add the hash of `exec.bat` (`50459310eded4c520ab5c9e3626a9300`) and the hash of the specific `wmiexec.py` script (if it can be recovered) to the EDR blocklist.






