# 	SOC117 - Suspicious .reg File (Event ID:81)


## Executive Summary

On February 6, 2021, the Security Operations Center (SOC) received an alert for a suspicious `.reg` file on the host **Aldo** (172.16.17.51). The investigation revealed that the `.reg` file was a container for a malicious batch script (`importantUpdate.Bat`). Dynamic analysis of this embedded script confirmed it to be a multi-functional **worm** with capabilities for persistence, defense evasion, and lateral movement. The worm's TTPs include creating services, modifying registry run keys, disabling Windows Defender and Firewall, and attempting to spread to other machines by mapping network shares. The alert details and a review of endpoint logs confirm that the endpoint security solution successfully **Blocked** this malicious file, preventing its execution and containing the threat. This is a **True Positive** for a real, albeit prevented, threat.

## Incident Details

The initial alert was triggered by the detection of a suspicious registry file:

<img width="1357" height="619" alt="image" src="https://github.com/user-attachments/assets/a905df96-19e4-4bc7-93f8-a255fe86bcfa" />

| | |
| :--- | :--- |
| **Date of Incident**| February 6, 2021 |
| **Source Host**| Aldo (172.16.17.51) |
| **Initial File**| `config.reg` |
| **Initial File Hash (MD5)**| `f705ac114767397fb5e7cd1603e70954` |
| **Payload File**| `importantUpdate.Bat` |
| **Payload Hash (MD5)**| `bf16a6aec517b7ec9c5d6eb3f4c60824` |
| **Attack Type**| Worm |
| **Case Link**| *([Case link](https://app.letsdefend.io/case-management/casedetail/sohankanna/50))* |

## Investigation and Analysis

### 1. Alert Triage and Initial Analysis

The investigation began by analyzing the `config.reg` file.
*   **Initial Triage:** `.reg` files are Windows Registry files. Attackers can use them to modify system settings or establish persistence. However, initial threat intelligence scans on the `.reg` file's hash were inconclusive, with zero detections on VirusTotal. This suggested the `.reg` file itself was not the primary threat but likely a container or dropper.
    <img width="1723" height="875" alt="image" src="https://github.com/user-attachments/assets/68f46805-de5c-42a7-a2df-1b46fa00eea2" />

### 2. Payload Extraction and Analysis

Extracting the contents of the `.reg` file revealed the true payload: a batch script named `importantUpdate.Bat`. This script was the real malware.
*   **Threat Intelligence (VirusTotal):** The hash of `importantUpdate.Bat` (`bf16a6aec517b7ec9c5d6eb3f4c60824`) was flagged as malicious by **17 security vendors**.
    <img width="1814" height="847" alt="image" src="https://github.com/user-attachments/assets/9041139f-7816-478f-b18f-b37974c21b95" />
*   **Dynamic Analysis (Hybrid Analysis):** A sandbox run provided a comprehensive view of the worm's malicious capabilities, scoring it **100/100**. The observed behaviors included:
    *   **Persistence (T1543.003, T1547.001):** The script creates a new Windows service named "DaMonki" (`sc create DaMonki...`) and adds a registry `Run` key to ensure it automatically starts at boot.
    *   **Defense Evasion (T1562.001, T1564.001):** It actively attempts to stop the Windows Defender and Windows Firewall services (`net stop "Windows Defender Service"`). It also uses the `attrib` command to set its files as hidden, system, and read-only to hide from the user.
    *   **Lateral Movement (T1021.002):** The script contains a loop that attempts to map the C$ administrative share of numerous IPs on the local network (`net use Z: \\192.168.1.x\C$`). If successful, it would likely copy itself to those machines to spread across the network. This is the defining characteristic of a worm.
    <img width="1693" height="763" alt="image" src="https://github.com/user-attachments/assets/708cf520-1da1-449f-9587-e8330ccb9d17" />

### 3. Confirmation of Successful Prevention

The investigation confirmed that the security controls on the endpoint successfully prevented the compromise.
*   **Device Action: Blocked:** The SIEM alert's status is the definitive piece of evidence. This indicates that the EDR/antivirus agent on the host **Aldo** detected the suspicious `.reg` file (or its contents) and blocked it from being fully written to disk or executed.
*   **Endpoint Log Verification:** A review of the process history on the host "Aldo" shows no execution of `config.reg` or the embedded `importantUpdate.Bat` script. This corroborates the "Blocked" status and confirms that none of the malicious actions observed in the sandbox (service creation, firewall disabling, etc.) actually occurred on the host.

## Skills and Tools Utilized

*   **Tools Used:** SIEM, EDR, VirusTotal, Hybrid Analysis
*   **Skills Demonstrated:** Malware Analysis (Worm), Persistence Technique Triage, Lateral Movement Triage, Dynamic Analysis.

## Playbook Solution: Incident Classification

*   **Analyze Malware:** **Malicious.** The embedded payload is a confirmed worm.
*   **Was Malware Quarantined/Cleaned?** **Yes.** The device action was "Blocked."
*   **Incident Classification:** **True Positive.** (A real threat was detected and stopped).

## Conclusion and Recommendations

The alert for SOC117 was a **true positive**. A user attempted to download or execute a file that contained a dangerous worm capable of disabling security features and spreading across the network. The endpoint security solution successfully **blocked** the threat, preventing infection and containment of the malware.

**Recommendations:**

1.  **Acknowledge Prevention:** Note the successful detection and prevention by the EDR/antivirus solution.
2.  **Verify Containment:** Although the EDR reported "Blocked," a best practice is to have a Tier 2 analyst run a full, updated AV scan on the host to ensure no remnants of the malware exist.
3.  **Investigate Initial Access:** The most critical follow-up action is to determine the initial vector. *How* did `config.reg` get onto the machine? Was it from a phishing email, a malicious web download, or a removable drive? An interview with the user (`Aldo`) is necessary.
4.  **BLOCK INDICATORS:**
    *   Add the hash of the initial file (`f705ac114767397fb5e7cd1603e70954`) and the embedded worm (`bf16a6aec517b7ec9c5d6eb3f4c60824`) to the EDR blocklist to prevent execution on other hosts.




