# 	SOC132 - Same Malicious File Found on Multiple Sources (Event ID:68)


## Executive Summary

On March 1, 2021, the Security Operations Center (SOC) received an alert that the same malicious file, `msi.bat`, was found on multiple hosts, including **MikeComputer**, **JohnComputer**, and **Sofia**. The investigation confirmed the file is a malicious dropper whose sole purpose is to execute a heavily obfuscated Python one-liner. Static analysis of this Python code revealed it to be a sophisticated reverse shell, designed to connect to a command-and-control (C2) server at **81.68.99.93** and give an attacker full remote control of the compromised machine. The alert details and a review of endpoint logs confirm that the endpoint security solution successfully detected this malicious file on all affected hosts and the **Device Action** was **Cleaned**. The threat was neutralized before it could establish a C2 connection. This is a **True Positive**.

## Incident Details

The initial alert was triggered by the detection of the same malicious file across multiple endpoints:

<img width="1447" height="513" alt="image" src="https://github.com/user-attachments/assets/871b21e4-89d0-441e-9ecf-e51ef3797c15" />

| | |
| :--- | :--- |
| **Date of Incident**| March 1, 2021 |
| **Affected Hosts**| MikeComputer (172.16.17.14), JohnComputer, Sofia |
| **Malware File**| msi.bat |
| **File Hash (MD5)**| 3dc649bc1be6f4881d386e679b7b60c8 |
| **Attacker C2 IP**| 81.68.99.93 |
| **Attack Type**| Reverse Shell / Backdoor |
| **Case Link**| *([Case link](https://app.letsdefend.io/case-management/casedetail/sohankanna/68))* |

## Investigation and Analysis

### 1. Malware Analysis (Obfuscated Python Reverse Shell)

The investigation focused on understanding the `msi.bat` file.
*   **Threat Intelligence:** VirusTotal confirmed the file was malicious, with 9 vendors flagging it.
    <img width="1641" height="873" alt="image" src="https://github.com/user-attachments/assets/11fb18ad-499c-4f1a-969d-38e276747976" />
*   **Static Code Analysis:** The batch file contains a single command designed to be executed by the Python interpreter. The Python code itself is a highly obfuscated one-liner.
    <img width="1281" height="342" alt="image" src="https://github.com/user-attachments/assets/35a46ce5-a559-49be-a171-c713fe7f45ce" />

    **Deconstructing the Malicious Python Code:**
    This one-line script is a compact and obfuscated reverse shell. Its purpose is to connect out to an attacker's server and give them a command prompt on the victim's machine. The obfuscation (using `lambda` functions and complex structures) is designed to hide its simple but dangerous goal.

    Here is what it does step-by-step:
    1.  **Imports Libraries:** It dynamically imports essential Python libraries: `socket` (for networking), `subprocess` (to run programs), and `threading` (to run tasks simultaneously).
    2.  **Launches Command Prompt:** It uses `subprocess.Popen` to start a hidden `cmd.exe` process. Crucially, it redirects the standard input, output, and error streams so the Python script can control them.
    3.  **Connects to Attacker:** It creates a TCP socket and connects to the hardcoded attacker IP address **`81.68.99.93`** on port **`443`**. Using port 443 (HTTPS) is a deliberate choice to make the malicious traffic blend in with normal encrypted web traffic and bypass simple firewalls.
    4.  **Creates Communication Bridge:** It launches two threads:
        *   One thread (`s2p` - socket-to-process) continuously listens for data coming from the attacker's server over the socket and writes it to the `cmd.exe` process's input. This is how the attacker sends commands.
        *   The other thread (`p2s` - process-to-socket) continuously reads the output from the `cmd.exe` process (the results of the commands) and sends it back to the attacker over the socket.
    5.  **Waits:** The main script then waits for the `cmd.exe` process to terminate, at which point it cleans up the connection.

    In summary, this code creates a direct, interactive command-line interface from the victim machine back to the attacker, giving them full control.

### 2. Confirmation of Successful Prevention

The investigation confirmed that the security controls on all affected endpoints successfully prevented the compromise.
*   **Device Action: Cleaned:** The SIEM alert's status is the definitive piece of evidence for all hosts. This indicates that the EDR/antivirus agent detected the malicious `msi.bat` file, terminated its execution, and removed/quarantined it.
*   **Network Log Verification:** A search of the network logs from all affected hosts (`MikeComputer`, `JohnComputer`, `Sofia`) showed **no outbound connections** to the C2 server `81.68.99.93`. This is a critical finding, proving the backdoor was stopped *before* it could become active.

## Skills and Tools Utilized

*   **Tools Used:** SIEM, EDR, VirusTotal, Hybrid Analysis, Static Code Analysis
*   **Skills Demonstrated:** Reverse Shell Analysis, Malware Triage, Log Correlation, Analysis of Obfuscated Code.

## Playbook Solution: Incident Classification

*   **Analyze Malware:** **Malicious.** The file is an obfuscated Python reverse shell.
*   **Was Malware Quarantined/Cleaned?** **Yes.** The device action was "Cleaned" on all affected hosts.
*   **Was C2 Requested?** **No, Not Accessed.** The malware was stopped before it could make outbound connections.
*   **Incident Classification:** **True Positive.** (A real, widespread threat was detected and stopped).

## Conclusion and Recommendations

The alert for SOC132 was a **true positive**. A malicious batch file designed to establish a reverse shell was found on at least three hosts. The endpoint security solution successfully detected and **cleaned** the threat on all machines, preventing the backdoors from connecting to their C2 server and stopping a widespread compromise.

**Recommendations:**

1.  **Acknowledge Prevention:** Note the successful detection and remediation across multiple hosts by the EDR/antivirus solution.
2.  **Verify Containment:** While the EDR reported "Cleaned," a best practice is to have a Tier 2 analyst run a full, updated AV scan on all three hosts (`MikeComputer`, `JohnComputer`, `Sofia`) to ensure no remnants of the malware exist.
3.  **Investigate Initial Access and Lateral Movement:** The most critical follow-up action is to determine the root cause of this widespread infection. How was `msi.bat` delivered and executed on three different machines? The IR team should investigate:
    *   **Phishing:** Was a malicious email sent to all three users?
    *   **Lateral Movement:** Did one of the machines get infected first, and then the malware spread to the other two? (e.g., via network shares). This is a high priority to investigate.
4.  **BLOCK INDICATORS:** Proactively block the C2 IP address `81.68.99.93` at the network firewall. Add the file hash `3dc649bc1be6f4881d386e679b7b60c8` to the EDR blocklist to prevent any chance of re-infection.


















