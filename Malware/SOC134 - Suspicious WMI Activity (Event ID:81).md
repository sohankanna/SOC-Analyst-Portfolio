# SOC134 - Suspicious WMI Activity (Event ID:81)

## Executive Summary

On March 15, 2021, the Security Operations Center (SOC) received a high-severity alert for suspicious Windows Management Instrumentation (WMI) activity on the **Exchange Server** (172.16.20.3). The investigation confirmed this activity was part of a ransomware infection initiated by the executable `lunch.exe`. Threat intelligence and dynamic sandbox analysis definitively identified the file as ransomware, noting its characteristic behaviors, including changing the desktop background, attempting to establish persistence, and querying system information. The alert details and a review of endpoint logs confirm that the endpoint security solution successfully detected this malicious activity and the **Device Action** was **Cleaned**. The threat was neutralized before it could complete its encryption routine or establish persistence. This is a **True Positive** for a real, albeit prevented, threat.

## Incident Details

The initial alert was triggered by the malware's use of WMI for reconnaissance or execution:

<img width="1351" height="614" alt="image" src="https://github.com/user-attachments/assets/6ea82273-eb67-43fd-b193-f0d66bd34ad4" />

| | |
| :--- | :--- |
| **Date of Incident**| March 15, 2021 |
| **Source Host**| Exchange Server (172.16.20.3) |
| **Malware File**| lunch.exe |
| **File Hash (MD5)**| f2b7074e1543720a9a98fda660e02688 |
| **Attack Type**| Ransomware |
| **Case Link**| *([Case link](https://app.letsdefend.io/case-management/casedetail/sohankanna/81))* |

## Investigation and Analysis

### 1. Alert Context: Suspicious WMI Activity

The rule `SOC134 - Suspicious WMI Activity` is designed to detect a common technique used by advanced malware and attackers. Windows Management Instrumentation (WMI) is a legitimate and powerful administrative framework. However, attackers abuse it for "living-off-the-land" techniques to perform reconnaissance (e.g., querying system information, as seen in the sandbox analysis), execute commands on remote systems, and establish fileless persistence. Any unexpected WMI activity, especially from an unknown executable, is a strong indicator of compromise.

### 2. Malware Analysis

A deep analysis of the `lunch.exe` file confirmed its highly malicious nature and identified it as ransomware.
*   **Threat Intelligence (VirusTotal):** The file hash was flagged as malicious by **58 out of 72 security vendors**, providing a definitive confirmation of the threat.
    <img width="1706" height="843" alt="image" src="https://github.com/user-attachments/assets/718c9150-cc16-4663-88fe-c9e19a31a80d" />
*   **Dynamic Analysis (Hybrid Analysis & Any.Run):** Sandbox analysis revealed classic ransomware and malware behaviors:
    *   **Ransomware:** The malware was observed **changing the desktop background picture**, a hallmark of ransomware used to display the ransom note. It also had the capability to shutdown/reboot the system.
    *   **Persistence:** It attempted to achieve persistence by modifying the `winlogon helper dll` registry key, a critical location that ensures the malware runs at system startup.
    *   **Reconnaissance/Fingerprinting:** It used WMI (`WMIC`) to read system information and queried sensitive Internet Explorer settings.
    *   **Visual Confirmation:** Screenshots from the Any.Run sandbox clearly show the changed desktop background and the creation of new files, visually confirming the ransomware's payload.
    <img width="1837" height="788" alt="image" src="https://github.com/user-attachments/assets/3d82cd37-779f-47f2-b9dc-44c764875322" />
    <img width="1786" height="693" alt="image" src="https://github.com/user-attachments/assets/23d6546f-3656-4557-b70e-e15d03daec95" />

### 3. Confirmation of Successful Prevention

The most critical finding of this investigation is that the attack was stopped before it could cause significant damage.
*   **Device Action: Cleaned:** The SIEM alert's status is the definitive piece of evidence. This indicates that the EDR/antivirus agent on the **Exchange Server** detected the malicious behaviors of `lunch.exe`, terminated the process, and removed/quarantined the file.
*   **Endpoint Log Verification:** A review of the endpoint security logs for the host confirms the absence of the `lunch.exe` process and any associated persistence mechanisms, corroborating the "Cleaned" status.

## Skills and Tools Utilized

*   **Tools Used:** SIEM, EDR, VirusTotal, Hybrid Analysis, Any.Run
*   **Skills Demonstrated:** Malware Analysis (Ransomware), TTP Recognition (WMI Abuse), Dynamic Analysis Triage, Log Correlation.

## Playbook Solution: Incident Classification

*   **Analyze Malware:** **Malicious.** The file is a confirmed ransomware executable.
*   **Was Malware Quarantined/Cleaned?** **Yes.** The device action was "Cleaned."
*   **Incident Classification:** **True Positive.** (A real threat was detected and stopped).

## Conclusion and Recommendations

The alert for SOC134 was a **true positive**. The **Exchange Server** was infected with ransomware, which began its execution routine. The endpoint security solution successfully detected and **cleaned** the threat, preventing file encryption and persistence. This is a successful defense scenario.

**Recommendations:**

1.  **Acknowledge Prevention:** Note the successful detection and remediation by the EDR/antivirus solution.
2.  **Verify Containment:** Although the EDR reported "Cleaned," a best practice is to have a Tier 2 analyst or system administrator perform a verification. This includes running a full, updated AV scan on the server and manually checking key persistence locations (like the Winlogon registry key) to ensure the threat was fully eradicated.
3.  **Investigate Initial Access:** The highest priority follow-up action is to determine **how `lunch.exe` was executed on the Exchange Server**. An Exchange server is a critical asset, and malware execution on it is a severe security failure. The IR team must be engaged to investigate potential causes, such as:
    *   Exploitation of a vulnerability on the Exchange Server (e.g., ProxyLogon, ProxyShell).
    *   A phishing email with the malware as an attachment being opened by an administrator on the server.
    *   Lateral movement from another already-compromised host on the network.
4.  **BLOCK INDICATORS:** Add the file hash `f2b7074e1543720a9a98fda660e02688` to the EDR blocklist to prevent any chance of re-infection.























